<script>
  let currentStep = 1;
  let selectedDate = null;
  let selectedTime = null;
  let teamData = null;
  let currentMonth = new Date();

  // --- Resolve team id/slug safely ---
  function resolveTeamId() {
    const q = new URLSearchParams(location.search);
    if (q.get('team')) return decodeURIComponent(q.get('team'));

    // support pretty links like /book/<id-or-slug>
    const segs = location.pathname.split('/').filter(Boolean);
    if (segs.length >= 2 && segs[0] === 'book') return decodeURIComponent(segs[1]);

    // NO team on generic /booking.html or /bookings → return null (don't call public endpoint)
    return null;
  }
  const teamId = resolveTeamId();

  // UI helpers
  function showToast(message) {
    const toast = document.getElementById('toast');
    document.getElementById('toastMessage').textContent = message;
    toast.classList.remove('hidden');
    setTimeout(() => toast.classList.add('hidden'), 3000);
  }

  // ---------------- Load team info (only when we have a team id/slug) ----------------
  async function loadTeam() {
    if (!teamId) {
      document.getElementById('teamName').textContent = 'Schedule a Meeting';
      document.getElementById('teamDescription').textContent =
        'Tip: open this page via /book/<teamId-or-slug> or add ?team=<teamId-or-slug>';
      return; // do NOT call /api/teams/:id/public
    }
    try {
      const resp = await fetch(`/api/teams/${encodeURIComponent(teamId)}/public`);
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      teamData = await resp.json(); // { id, name, description }
      document.getElementById('teamName').textContent = teamData.name || 'Team';
      document.getElementById('teamDescription').textContent =
        teamData.description || 'Select a date and time to book a meeting';

      // Keep numeric id for submit even if URL used a slug
      const formEl = document.getElementById('bookingForm');
      if (teamData.id && formEl) formEl.dataset.numericTeamId = String(teamData.id);
    } catch (e) {
      console.error('Error loading team:', e);
      document.getElementById('teamName').textContent = 'Team Not Found';
      document.getElementById('teamDescription').textContent =
        'This booking link may be invalid.';
      // still allow picking date/time, but submit will guard
    }
  }

  // ---------------- Calendar + time UI (unchanged) ----------------
  function generateCalendar() {
    const year = currentMonth.getFullYear();
    const month = currentMonth.getMonth();

    document.getElementById('currentMonth').textContent =
      currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const today = new Date(); today.setHours(0,0,0,0);

    const container = document.getElementById('calendarDays');
    container.innerHTML = '';

    for (let i = 0; i < firstDay; i++) container.innerHTML += '<div></div>';

    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const isPast = date < today;
      const dateStr = date.toISOString().split('T')[0];
      container.innerHTML += `
        <div onclick="${isPast ? '' : `selectDate('${dateStr}')`}"
             class="calendar-day ${isPast ? 'disabled' : ''} p-4 bg-white bg-opacity-20 rounded-lg text-center font-semibold">
          ${day}
        </div>`;
    }
  }
  function previousMonth(){ currentMonth.setMonth(currentMonth.getMonth()-1); generateCalendar(); }
  function nextMonth(){ currentMonth.setMonth(currentMonth.getMonth()+1); generateCalendar(); }

  function selectDate(dateStr) {
    selectedDate = dateStr;
    const date = new Date(dateStr);
    document.getElementById('selectedDate').textContent =
      date.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    generateTimeSlots();
    goToStep(2);
  }

  function generateTimeSlots() {
    const container = document.getElementById('timeSlots');
    const slots = [];
    for (let hour = 9; hour <= 17; hour++) {
      slots.push(`${hour % 12 || 12}:00 ${hour < 12 ? 'AM' : 'PM'}`);
      if (hour < 17) slots.push(`${hour % 12 || 12}:30 ${hour < 12 ? 'AM' : 'PM'}`);
    }
    container.innerHTML = slots.map(time => `
      <button onclick="selectTime('${time}')"
              class="time-slot-btn px-4 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 font-semibold">
        ${time}
      </button>`).join('');
  }

  function selectTime(time) {
    selectedTime = time;
    document.querySelectorAll('.time-slot-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.classList.add('selected');

    const date = new Date(selectedDate);
    document.getElementById('bookingSummary').innerHTML = `
      <strong>Date:</strong> ${date.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' })}<br>
      <strong>Time:</strong> ${selectedTime}<br>
      <strong>Duration:</strong> 30 minutes`;
    setTimeout(() => goToStep(3), 500);
  }

  function goToStep(step) {
    currentStep = step;
    for (let i = 1; i <= 4; i++) {
      document.getElementById(`step${i}`).classList.add('hidden');
      document.getElementById(`step${i}Indicator`)?.classList.add('opacity-50');
    }
    document.getElementById(`step${step}`).classList.remove('hidden');
    document.getElementById(`step${step}Indicator`)?.classList.remove('opacity-50');
  }

  // ---------------- Submit booking (robust) ----------------
  async function submitBooking(ev) {
    ev.preventDefault();

    // prefer numeric id saved from public fetch, else fallback to URL id/slug
    const formEl = ev.currentTarget;
    const numericId = formEl.dataset.numericTeamId;
    const resolvedTeam = numericId || teamId;

    if (!resolvedTeam) {
      showToast('No team specified. Open via /book/<teamId-or-slug> or add ?team=<id-or-slug>.');
      return;
    }
    if (!selectedDate || !selectedTime) {
      showToast('Please select a date and time first.');
      return;
    }

    const payload = {
      team_id: resolvedTeam, // server accepts numeric id OR public_url slug
      date: selectedDate,
      time: selectedTime,
      guest_name: document.getElementById('guestName').value.trim(),
      guest_email: document.getElementById('guestEmail').value.trim(),
      guest_notes: document.getElementById('guestNotes').value.trim() || ''
    };

    if (!payload.guest_name || !payload.guest_email) {
      showToast('Please complete name and email.');
      return;
    }

    try {
      const resp = await fetch('/api/bookings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));

      if (!resp.ok) {
        console.error('Booking failed:', resp.status, data);
        showToast(data?.error || 'Failed to create booking. Please try again.');
        return;
      }

      // Success — show confirmation
      showConfirmation(payload);
    } catch (e) {
      console.error('Network error creating booking:', e);
      showToast('Network error creating booking. Please try again.');
    }
  }

  function showConfirmation(data) {
    const date = new Date(data.date);
    document.getElementById('confirmationDetails').innerHTML = `
      <div><strong>Team:</strong> ${teamData?.name || '—'}</div>
      <div><strong>Date:</strong> ${date.toLocaleDateString('en-US', { weekday:'long', year:'numeric', month:'long', day:'numeric' })}</div>
      <div><strong>Time:</strong> ${data.time}</div>
      <div><strong>Name:</strong> ${data.guest_name}</div>
      <div><strong>Email:</strong> ${data.guest_email}</div>`;
    goToStep(4);
  }

  // ---------------- Init ----------------
  loadTeam();       // will no-op (and not 404) if there is no teamId
  generateCalendar();

  // expose submitBooking to inline onsubmit
  window.submitBooking = submitBooking;
  window.previousMonth = previousMonth;
  window.nextMonth = nextMonth;
  window.selectDate = selectDate;
  window.selectTime = selectTime;
  window.goToStep = goToStep;
</script>
