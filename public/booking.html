<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book a Meeting - ScheduleSync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .time-slot-btn {
            transition: all 0.2s ease;
        }
        .time-slot-btn:hover:not(:disabled) {
            transform: scale(1.05);
        }
        .time-slot-btn.selected {
            background: white;
            color: #764ba2;
        }
        .calendar-day {
            transition: all 0.2s ease;
        }
        .calendar-day:hover:not(.disabled) {
            transform: scale(1.05);
            cursor: pointer;
        }
        .calendar-day.selected {
            background: white;
            color: #764ba2;
        }
        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="text-white">
    <!-- Header -->
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-5xl font-bold mb-4">⚡ ScheduleSync</h1>
            <p class="text-xl text-purple-200">Schedule your meeting</p>
        </div>

        <!-- Main Booking Container -->
        <div class="max-w-4xl mx-auto">
            <!-- Step Indicator -->
            <div class="mb-8 flex justify-center space-x-4">
                <div id="step1Indicator" class="flex items-center space-x-2">
                    <div class="w-8 h-8 rounded-full bg-white text-purple-600 flex items-center justify-center font-bold">1</div>
                    <span class="font-semibold">Select Date</span>
                </div>
                <div class="w-16 h-1 bg-white bg-opacity-30 self-center"></div>
                <div id="step2Indicator" class="flex items-center space-x-2 opacity-50">
                    <div class="w-8 h-8 rounded-full bg-white text-purple-600 flex items-center justify-center font-bold">2</div>
                    <span class="font-semibold">Select Time</span>
                </div>
                <div class="w-16 h-1 bg-white bg-opacity-30 self-center"></div>
                <div id="step3Indicator" class="flex items-center space-x-2 opacity-50">
                    <div class="w-8 h-8 rounded-full bg-white text-purple-600 flex items-center justify-center font-bold">3</div>
                    <span class="font-semibold">Your Details</span>
                </div>
            </div>

            <!-- Team Info -->
            <div id="teamInfo" class="glass rounded-lg p-6 mb-6">
                <div class="flex items-center space-x-4">
                    <div class="w-16 h-16 bg-white bg-opacity-20 rounded-full flex items-center justify-center text-3xl">
                        👥
                    </div>
                    <div>
                        <h2 id="teamName" class="text-2xl font-bold">Loading...</h2>
                        <p id="teamDescription" class="text-purple-200">Please wait...</p>
                    </div>
                </div>
            </div>

            <!-- Step 1: Date Selection -->
            <div id="step1" class="glass rounded-lg p-8">
                <h3 class="text-2xl font-bold mb-6">Select a Date</h3>
                
                <!-- Month Navigation -->
                <div class="flex justify-between items-center mb-6">
                    <button onclick="previousMonth()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                        ← Previous
                    </button>
                    <h4 id="currentMonth" class="text-xl font-semibold"></h4>
                    <button onclick="nextMonth()" class="px-4 py-2 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                        Next →
                    </button>
                </div>

                <!-- Calendar Grid -->
                <div class="grid grid-cols-7 gap-2">
                    <div class="text-center font-semibold p-2">Sun</div>
                    <div class="text-center font-semibold p-2">Mon</div>
                    <div class="text-center font-semibold p-2">Tue</div>
                    <div class="text-center font-semibold p-2">Wed</div>
                    <div class="text-center font-semibold p-2">Thu</div>
                    <div class="text-center font-semibold p-2">Fri</div>
                    <div class="text-center font-semibold p-2">Sat</div>
                </div>
                <div id="calendarDays" class="grid grid-cols-7 gap-2 mt-2">
                    <!-- Calendar days will be generated here -->
                </div>
            </div>

            <!-- Step 2: Time Selection -->
            <div id="step2" class="hidden glass rounded-lg p-8">
                <h3 class="text-2xl font-bold mb-2">Select a Time</h3>
                <p class="text-purple-200 mb-6">
                    <span id="selectedDate"></span> • Time zone: Philippine Time (GMT+8)
                </p>
                
                <div id="timeSlots" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Time slots will be generated here -->
                </div>

                <div class="mt-6">
                    <button onclick="goToStep(1)" class="px-6 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                        ← Back to Date
                    </button>
                </div>
            </div>

            <!-- Step 3: Guest Details -->
            <div id="step3" class="hidden glass rounded-lg p-8">
                <h3 class="text-2xl font-bold mb-6">Enter Your Details</h3>
                
                <form id="bookingForm" onsubmit="submitBooking(event)">
                    <div class="mb-4">
                        <label class="block mb-2 font-semibold">Your Name *</label>
                        <input type="text" id="guestName" required
                               class="w-full px-4 py-3 bg-white bg-opacity-20 rounded-lg border border-white border-opacity-30 text-white placeholder-purple-200"
                               placeholder="John Doe">
                    </div>

                    <div class="mb-4">
                        <label class="block mb-2 font-semibold">Email Address *</label>
                        <input type="email" id="guestEmail" required
                               class="w-full px-4 py-3 bg-white bg-opacity-20 rounded-lg border border-white border-opacity-30 text-white placeholder-purple-200"
                               placeholder="john@example.com">
                    </div>

                    <div class="mb-6">
                        <label class="block mb-2 font-semibold">Notes (Optional)</label>
                        <textarea id="guestNotes" rows="4"
                                  class="w-full px-4 py-3 bg-white bg-opacity-20 rounded-lg border border-white border-opacity-30 text-white placeholder-purple-200"
                                  placeholder="What would you like to discuss?"></textarea>
                    </div>

                    <div class="bg-white bg-opacity-10 rounded-lg p-4 mb-6">
                        <h4 class="font-semibold mb-2">Meeting Summary:</h4>
                        <p id="bookingSummary" class="text-purple-200"></p>
                    </div>

                    <div class="flex space-x-3">
                        <button type="button" onclick="goToStep(2)" class="flex-1 px-6 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30">
                            ← Back
                        </button>
                        <button type="submit" class="flex-1 px-6 py-3 bg-white text-purple-600 rounded-lg font-semibold hover:bg-purple-50">
                            Confirm Booking
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 4: Confirmation -->
            <div id="step4" class="hidden glass rounded-lg p-8 text-center">
                <div class="text-6xl mb-4">✅</div>
                <h3 class="text-3xl font-bold mb-4">Booking Confirmed!</h3>
                <p class="text-xl text-purple-200 mb-8">
                    Your meeting has been scheduled. You'll receive a confirmation email shortly.
                </p>
                
                <div class="bg-white bg-opacity-10 rounded-lg p-6 mb-8 text-left max-w-md mx-auto">
                    <h4 class="font-semibold mb-4">Meeting Details:</h4>
                    <p id="confirmationDetails" class="text-purple-200 space-y-2"></p>
                </div>

                <a href="/" class="inline-block px-8 py-3 bg-white text-purple-600 rounded-lg font-semibold hover:bg-purple-50">
                    Done
                </a>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="hidden fixed bottom-4 right-4 glass px-6 py-4 rounded-lg shadow-lg z-50">
        <p id="toastMessage"></p>
    </div>

    <script>
        let currentStep = 1;
        let selectedDate = null;
        let selectedTime = null;
        let teamData = null;
        let currentMonth = new Date();

        // Get team ID from URL
        const urlParams = new URLSearchParams(window.location.search);
        const teamId = urlParams.get('team') || window.location.pathname.split('/').pop();

        // Load team info
        async function loadTeam() {
            try {
                const response = await fetch(`/api/teams/${teamId}/public`);
                if (response.ok) {
                    teamData = await response.json();
                    document.getElementById('teamName').textContent = teamData.name;
                    document.getElementById('teamDescription').textContent = teamData.description || 'Select a date and time to book a meeting';
                } else {
                    document.getElementById('teamName').textContent = 'Team Not Found';
                    document.getElementById('teamDescription').textContent = 'This booking link may be invalid';
                }
            } catch (error) {
                console.error('Error loading team:', error);
                showToast('Error loading team information');
            }
        }

        // Generate calendar
        function generateCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            document.getElementById('currentMonth').textContent = 
                currentMonth.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const container = document.getElementById('calendarDays');
            container.innerHTML = '';

            // Empty cells before first day
            for (let i = 0; i < firstDay; i++) {
                container.innerHTML += '<div></div>';
            }

            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const isPast = date < today;
                const dateStr = date.toISOString().split('T')[0];

                container.innerHTML += `
                    <div onclick="${isPast ? '' : `selectDate('${dateStr}')`}" 
                         class="calendar-day ${isPast ? 'disabled' : ''} p-4 bg-white bg-opacity-20 rounded-lg text-center font-semibold">
                        ${day}
                    </div>
                `;
            }
        }

        // Calendar navigation
        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            generateCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            generateCalendar();
        }

        // Select date
        function selectDate(dateStr) {
            selectedDate = dateStr;
            const date = new Date(dateStr);
            document.getElementById('selectedDate').textContent = 
                date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            generateTimeSlots();
            goToStep(2);
        }

        // Generate time slots
        function generateTimeSlots() {
            const container = document.getElementById('timeSlots');
            const slots = [];
            
            // Generate slots from 9 AM to 5 PM
            for (let hour = 9; hour <= 17; hour++) {
                slots.push(`${hour % 12 || 12}:00 ${hour < 12 ? 'AM' : 'PM'}`);
                if (hour < 17) {
                    slots.push(`${hour % 12 || 12}:30 ${hour < 12 ? 'AM' : 'PM'}`);
                }
            }

            container.innerHTML = slots.map(time => `
                <button onclick="selectTime('${time}')" 
                        class="time-slot-btn px-4 py-3 bg-white bg-opacity-20 rounded-lg hover:bg-opacity-30 font-semibold">
                    ${time}
                </button>
            `).join('');
        }

        // Select time
        function selectTime(time) {
            selectedTime = time;
            
            // Update all time slot buttons
            document.querySelectorAll('.time-slot-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            event.target.classList.add('selected');

            // Update booking summary
            const date = new Date(selectedDate);
            document.getElementById('bookingSummary').innerHTML = `
                <strong>Date:</strong> ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}<br>
                <strong>Time:</strong> ${selectedTime}<br>
                <strong>Duration:</strong> 30 minutes
            `;

            setTimeout(() => goToStep(3), 500);
        }

        // Navigate steps
        function goToStep(step) {
            currentStep = step;
            
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`step${i}`).classList.add('hidden');
                document.getElementById(`step${i}Indicator`)?.classList.add('opacity-50');
            }
            
            // Show current step
            document.getElementById(`step${step}`).classList.remove('hidden');
            document.getElementById(`step${step}Indicator`)?.classList.remove('opacity-50');
        }

        // Submit booking
        async function submitBooking(event) {
            event.preventDefault();

            const bookingData = {
                team_id: teamId,
                date: selectedDate,
                time: selectedTime,
                guest_name: document.getElementById('guestName').value,
                guest_email: document.getElementById('guestEmail').value,
                guest_notes: document.getElementById('guestNotes').value
            };

            try {
                const response = await fetch('/api/bookings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(bookingData)
                });

                if (response.ok) {
                    const result = await response.json();
                    showConfirmation(bookingData);
                } else {
                    showToast('Failed to create booking. Please try again.');
                }
            } catch (error) {
                console.error('Error creating booking:', error);
                showToast('Failed to create booking. Please try again.');
            }
        }

        // Show confirmation
        function showConfirmation(data) {
            const date = new Date(data.date);
            document.getElementById('confirmationDetails').innerHTML = `
                <div><strong>Team:</strong> ${teamData.name}</div>
                <div><strong>Date:</strong> ${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>
                <div><strong>Time:</strong> ${data.time}</div>
                <div><strong>Name:</strong> ${data.guest_name}</div>
                <div><strong>Email:</strong> ${data.guest_email}</div>
            `;
            goToStep(4);
        }

        // Show toast
        function showToast(message) {
            const toast = document.getElementById('toast');
            document.getElementById('toastMessage').textContent = message;
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }

        // Initialize
        loadTeam();
        generateCalendar();
    </script>
</body>
</html>