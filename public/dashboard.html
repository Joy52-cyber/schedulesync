<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - ScheduleSync</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .sidebar { position: fixed; left: 0; top: 0; height: 100vh; width: 250px; background: #1a202c; overflow-y: auto; z-index: 40; }
    .sidebar-link { display: flex; align-items: center; gap: 10px; padding: 12px 20px; color: #cbd5e0; transition: all 0.2s; cursor: pointer; }
    .sidebar-link:hover { background: #2d3748; color: white; }
    .sidebar-link.active { background: #667eea; color: white; }
    .main-content { margin-left: 250px; }
    .metric-card { background: white; border-radius: 8px; padding: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .metric-value { font-size: 32px; font-weight: bold; color: #1a202c; }
    .metric-label { color: #718096; font-size: 14px; margin-top: 5px; }
    .section-title { font-size: 24px; font-weight: bold; color: #1a202c; margin-bottom: 20px; }
    .fade-in { animation: fadeIn 0.3s ease-in; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .btn-primary { background: #667eea; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-primary:hover { background: #5568d3; }
    .btn-secondary { background: #e2e8f0; color: #1a202c; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-secondary:hover { background: #cbd5e0; }
    .btn-danger { background: #f56565; color: white; padding: 10px 20px; border-radius: 6px; border: none; cursor: pointer; }
    .btn-danger:hover { background: #e53e3e; }
    .google-card { background: linear-gradient(135deg, #4285F4 0%, #34A853 100%); }
    .microsoft-card { background: linear-gradient(135deg, #0078D4 0%, #107C10 100%); }
    .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-active { background: #c6f6d5; color: #22543d; }
  </style>
</head>
<body class="bg-gray-100">
  <!-- Sidebar -->
  <div class="sidebar">
    <div class="px-6 py-8 border-b border-gray-700">
      <div class="flex items-center gap-2 mb-2">
        <div class="text-2xl">📅</div>
        <div class="font-bold text-white text-lg">ScheduleSync</div>
      </div>
      <p class="text-xs text-gray-400">Admin Dashboard</p>
    </div>

    <div class="py-6">
      <div class="sidebar-link active" onclick="switchTab('overview', event)">
        <span>📊</span>
        <span>Overview</span>
      </div>
      <div class="sidebar-link" onclick="switchTab('teams', event)">
        <span>👥</span>
        <span>Teams</span>
      </div>
      <div class="sidebar-link" onclick="switchTab('bookings', event)">
        <span>📆</span>
        <span>Bookings</span>
      </div>
      <div class="sidebar-link" onclick="switchTab('integrations', event)">
        <span>🔗</span>
        <span>Integrations</span>
      </div>
      <div class="sidebar-link" onclick="switchTab('analytics', event)">
        <span>📈</span>
        <span>Analytics</span>
      </div>
      <div class="sidebar-link" onclick="logout()">
        <span>🚪</span>
        <span>Logout</span>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Top Navigation -->
    <nav class="gradient-bg text-white shadow-lg sticky top-0 z-30">
      <div class="px-8 py-4 flex justify-between items-center">
        <h1 class="text-xl font-bold" id="page-title">Dashboard Overview</h1>
        <div class="flex items-center gap-4">
          <span id="user-name">Loading...</span>
          <button onclick="logout()" class="px-4 py-2 bg-white/20 hover:bg-white/30 rounded-lg transition">Sign Out</button>
        </div>
      </div>
    </nav>

    <!-- Page Content -->
    <div class="p-8">
      
      <!-- Overview Tab -->
      <div id="overview-tab" class="fade-in">
        <div class="section-title">Dashboard Overview</div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <div class="metric-card">
            <div class="metric-value" id="total-teams">0</div>
            <div class="metric-label">Total Teams</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="total-bookings">0</div>
            <div class="metric-label">Total Bookings</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="confirmed-bookings">0</div>
            <div class="metric-label">Confirmed</div>
          </div>
          <div class="metric-card">
            <div class="metric-value" id="pending-bookings">0</div>
            <div class="metric-label">Pending</div>
          </div>
        </div>
      </div>

      <!-- Teams Tab -->
      <div id="teams-tab" class="fade-in" style="display: none;">
        <div class="section-title">Teams Management</div>
        <button onclick="alert('Create team functionality')" class="btn-primary mb-4">+ Create Team</button>
        <div class="metric-card">
          <p class="text-gray-600">Your teams will appear here</p>
        </div>
      </div>

      <!-- Bookings Tab -->
      <div id="bookings-tab" class="fade-in" style="display: none;">
        <div class="section-title">Bookings</div>
        <div class="metric-card">
          <p class="text-gray-600">Your bookings will appear here</p>
        </div>
      </div>

      <!-- INTEGRATIONS TAB - NEW -->
      <div id="integrations-tab" class="fade-in" style="display: none;">
        <div class="section-title">🔗 Calendar Integrations</div>
        
        <!-- Connected Calendars -->
        <div class="metric-card mb-6">
          <h3 class="text-lg font-bold mb-4">✓ Connected Calendars</h3>
          <div id="connected-calendars-list">
            <p class="text-gray-500">Loading your calendars...</p>
          </div>
        </div>

        <!-- Connect New Calendars -->
        <div class="metric-card mb-6">
          <h3 class="text-lg font-bold mb-6">+ Connect New Calendar</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Google Calendar Card -->
            <div class="google-card text-white rounded-lg p-8 cursor-pointer hover:shadow-lg transition">
              <div style="font-size: 40px; margin-bottom: 16px;">🔵</div>
              <h4 style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">Google Calendar</h4>
              <p style="font-size: 14px; opacity: 0.95; margin-bottom: 20px;">Sync your Google Calendar events and prevent conflicts</p>
              <button onclick="connectGoogle()" class="w-full py-3 bg-white text-blue-600 font-bold rounded-lg hover:bg-gray-100 transition">
                Connect Google Calendar
              </button>
            </div>

            <!-- Microsoft Outlook Card -->
            <div class="microsoft-card text-white rounded-lg p-8 cursor-pointer hover:shadow-lg transition">
              <div style="font-size: 40px; margin-bottom: 16px;">📧</div>
              <h4 style="font-weight: bold; font-size: 18px; margin-bottom: 8px;">Microsoft Outlook</h4>
              <p style="font-size: 14px; opacity: 0.95; margin-bottom: 20px;">Sync your Outlook Calendar events and prevent conflicts</p>
              <button onclick="connectMicrosoft()" class="w-full py-3 bg-white text-blue-600 font-bold rounded-lg hover:bg-gray-100 transition">
                Connect Microsoft Outlook
              </button>
            </div>
          </div>
        </div>

        <!-- How It Works -->
        <div class="metric-card">
          <h3 class="text-lg font-bold mb-4">📚 How It Works</h3>
          <div style="background: #f0f4ff; border-left: 4px solid #667eea; padding: 16px; border-radius: 6px;">
            <p style="margin: 0; color: #1a202c; line-height: 1.8; font-size: 15px;">
              <strong>Connected calendars automatically prevent double-booking.</strong> When guests book meetings, ScheduleSync checks all your connected calendars and only shows you truly available time slots. You can connect multiple calendars from different providers (Google, Microsoft, etc.).
            </p>
          </div>
        </div>
      </div>

      <!-- Analytics Tab -->
      <div id="analytics-tab" class="fade-in" style="display: none;">
        <div class="section-title">Analytics & Insights</div>
        <div class="metric-card">
          <p class="text-gray-600">Analytics data will appear here</p>
        </div>
      </div>

    </div>
  </div>

  <script>
    const API_BASE = `${window.location.protocol}//${window.location.host}`;
    let currentTab = 'overview';

    // Initialize on page load
    async function init() {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login';
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/users/me`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        document.getElementById('user-name').textContent = data.user?.name || 'User';
      } catch (error) {
        console.error('Error loading user info:', error);
      }

      // Load initial data
      loadDashboardData();
    }

    async function loadDashboardData() {
      try {
        const response = await fetch(`${API_BASE}/api/analytics/dashboard`);
        const data = await response.json();
        
        document.getElementById('total-teams').textContent = data.stats?.totalTeams || 0;
        document.getElementById('total-bookings').textContent = data.stats?.totalBookings || 0;
        document.getElementById('confirmed-bookings').textContent = data.stats?.confirmedBookings || 0;
        document.getElementById('pending-bookings').textContent = data.stats?.pendingBookings || 0;
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }

    // Switch between tabs
    function switchTab(tab, event) {
      if (event) event.preventDefault();
      
      // Hide all tabs
      document.querySelectorAll('[id$="-tab"]').forEach(el => {
        el.style.display = 'none';
      });

      // Show selected tab
      const tabEl = document.getElementById(tab + '-tab');
      if (tabEl) {
        tabEl.style.display = 'block';
        tabEl.classList.add('fade-in');
      }

      // Update sidebar active state
      document.querySelectorAll('.sidebar-link').forEach(link => {
        link.classList.remove('active');
      });
      if (event && event.target) {
        event.target.closest('.sidebar-link')?.classList.add('active');
      }

      // Update page title
      const titles = {
        'overview': 'Dashboard Overview',
        'teams': 'Teams Management',
        'bookings': 'Bookings',
        'integrations': '🔗 Calendar Integrations',
        'analytics': 'Analytics & Insights'
      };
      document.getElementById('page-title').textContent = titles[tab] || 'Dashboard';

      // Load integrations data if switching to integrations tab
      if (tab === 'integrations') {
        loadConnectedCalendars();
      }

      currentTab = tab;
    }

    // ========================
    // CALENDAR INTEGRATION FUNCTIONS
    // ========================

    async function loadConnectedCalendars() {
      try {
        const response = await fetch(`${API_BASE}/api/calendar/connections`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        displayConnectedCalendars(data.connections || []);
      } catch (error) {
        console.error('Error loading calendars:', error);
        document.getElementById('connected-calendars-list').innerHTML = '<p class="text-red-500">Error loading calendars</p>';
      }
    }

    function displayConnectedCalendars(connections) {
      if (!connections || connections.length === 0) {
        document.getElementById('connected-calendars-list').innerHTML = '<p class="text-gray-500">No calendars connected yet. Connect one to get started!</p>';
        return;
      }

      const html = connections.map(conn => {
        const providerIcon = conn.provider === 'google' ? '🔵' : '📧';
        const providerName = conn.provider === 'google' ? 'Google Calendar' : 'Microsoft Outlook';
        const lastSync = conn.updated_at ? new Date(conn.updated_at).toLocaleDateString() : 'Never';
        
        return `
          <div style="background: #f7fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
            <div>
              <div style="font-size: 24px; margin-bottom: 8px;">${providerIcon}</div>
              <p style="font-weight: 600; margin: 0; color: #1a202c; font-size: 16px;">${providerName}</p>
              <p style="font-size: 12px; color: #718096; margin: 4px 0 0 0;">Connected on ${lastSync}</p>
              <p style="font-size: 12px; color: #22863a; margin: 4px 0 0 0;">✓ Active & Syncing</p>
            </div>
            <button onclick="disconnectCalendar('${conn.provider}')" class="btn-danger">Disconnect</button>
          </div>
        `;
      }).join('');

      document.getElementById('connected-calendars-list').innerHTML = html;
    }

    async function connectGoogle() {
      try {
        const response = await fetch(`${API_BASE}/api/calendar/google/auth`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Google Calendar is not configured on the server. Please check environment variables.');
        }
      } catch (error) {
        alert('Error connecting to Google Calendar: ' + error.message);
      }
    }

    async function connectMicrosoft() {
      try {
        const response = await fetch(`${API_BASE}/api/calendar/microsoft/auth`, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
        });
        const data = await response.json();
        
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert('Microsoft Outlook is not configured on the server. Please check environment variables.');
        }
      } catch (error) {
        alert('Error connecting to Microsoft Outlook: ' + error.message);
      }
    }

    async function disconnectCalendar(provider) {
      if (!confirm(`Are you sure you want to disconnect ${provider === 'google' ? 'Google Calendar' : 'Microsoft Outlook'}?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/api/calendar/disconnect`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${localStorage.getItem('token')}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ provider })
        });

        if (response.ok) {
          alert(`${provider === 'google' ? 'Google Calendar' : 'Microsoft Outlook'} disconnected successfully`);
          loadConnectedCalendars();
        } else {
          alert('Error disconnecting calendar');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    }

    function logout() {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>