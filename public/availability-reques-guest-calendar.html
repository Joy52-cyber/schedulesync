<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Your Availability - ScheduleSync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e8ecf3 100%);
            min-height: 100vh;
        }
        .calendar-option {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .calendar-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(124, 58, 237, 0.15);
        }
        .calendar-option.selected {
            border-color: #7c3aed;
            background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%);
        }
        .time-slot {
            transition: all 0.2s ease;
        }
        .time-slot:hover {
            transform: translateX(2px);
            background: rgba(124, 58, 237, 0.05);
        }
        .time-slot.selected {
            background: #7c3aed;
            color: white;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="text-6xl mb-4">📅</div>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">Schedule a Meeting</h1>
            <p class="text-gray-600" id="teamInfo">Loading...</p>
        </div>

        <!-- Error/Success Messages -->
        <div id="errorMessage" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg text-red-800"></div>
        <div id="successMessage" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg text-green-800"></div>

        <!-- Method Selection -->
        <div id="methodSelection" class="bg-white rounded-2xl shadow-lg p-8 mb-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 text-center">How would you like to share your availability?</h2>
            <p class="text-gray-600 text-center mb-6">Choose the method that works best for you</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Google Calendar Option -->
                <div class="calendar-option border-2 rounded-xl p-6 text-center" onclick="selectMethod('google')">
                    <div class="text-5xl mb-3">🗓️</div>
                    <h3 class="font-bold text-lg mb-2">Connect Google Calendar</h3>
                    <p class="text-sm text-gray-600 mb-4">Automatically find mutual free time</p>
                    <div class="flex items-center justify-center gap-2 text-sm text-green-600">
                        <span>✓</span> Instant
                        <span>✓</span> Accurate
                        <span>✓</span> Easy
                    </div>
                </div>

                <!-- Manual Option -->
                <div class="calendar-option border-2 rounded-xl p-6 text-center" onclick="selectMethod('manual')">
                    <div class="text-5xl mb-3">⏰</div>
                    <h3 class="font-bold text-lg mb-2">Enter Availability Manually</h3>
                    <p class="text-sm text-gray-600 mb-4">Select your available time slots</p>
                    <div class="flex items-center justify-center gap-2 text-sm text-blue-600">
                        <span>✓</span> No sign-in
                        <span>✓</span> Quick
                        <span>✓</span> Simple
                    </div>
                </div>
            </div>
        </div>

        <!-- Google Calendar Flow -->
        <div id="googleFlow" class="hidden">
            <!-- Step 1: Connect Calendar -->
            <div id="connectStep" class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Connect Your Google Calendar</h2>
                <p class="text-gray-600 mb-6">We'll check your calendar to find times that work for both of you</p>

                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                    <h3 class="font-semibold text-blue-900 mb-2">What happens next:</h3>
                    <ul class="space-y-2 text-sm text-blue-800">
                        <li class="flex items-start gap-2">
                            <span class="text-green-600">1.</span>
                            <span>You'll authorize ScheduleSync to view your calendar availability (read-only)</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-600">2.</span>
                            <span>We'll instantly find mutual free time slots</span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="text-green-600">3.</span>
                            <span>You pick a time, and the meeting is automatically added to both calendars with a Google Meet link</span>
                        </li>
                    </ul>
                </div>

                <button 
                    onclick="connectGoogleCalendar()" 
                    class="w-full bg-white border-2 border-gray-300 text-gray-800 font-semibold py-4 px-6 rounded-lg hover:border-gray-400 transition flex items-center justify-center gap-3"
                >
                    <svg class="w-6 h-6" viewBox="0 0 48 48">
                        <path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"/>
                        <path fill="#34A853" d="M24 46c5.94 0 10.92-1.97 14.56-5.33l-7.11-5.52c-1.97 1.32-4.49 2.1-7.45 2.1-5.73 0-10.58-3.87-12.31-9.07H4.34v5.7C7.96 41.07 15.4 46 24 46z"/>
                        <path fill="#FBBC05" d="M11.69 28.18C11.25 26.86 11 25.45 11 24s.25-2.86.69-4.18v-5.7H4.34C2.85 17.09 2 20.45 2 24c0 3.55.85 6.91 2.34 9.88l7.35-5.7z"/>
                        <path fill="#EA4335" d="M24 10.75c3.23 0 6.13 1.11 8.41 3.29l6.31-6.31C34.91 4.18 29.93 2 24 2 15.4 2 7.96 6.93 4.34 14.12l7.35 5.7c1.73-5.2 6.58-9.07 12.31-9.07z"/>
                    </svg>
                    Connect Google Calendar
                </button>

                <button onclick="selectMethod('manual')" class="w-full mt-3 text-gray-600 hover:text-gray-800 py-2">
                    ← Use manual entry instead
                </button>
            </div>

            <!-- Step 2: Loading -->
            <div id="loadingSlots" class="hidden bg-white rounded-2xl shadow-lg p-8 mb-6 text-center">
                <div class="animate-spin rounded-full h-16 w-16 border-4 border-purple-600 border-t-transparent mx-auto mb-4"></div>
                <h3 class="text-xl font-semibold text-gray-800 mb-2">Finding Available Times...</h3>
                <p class="text-gray-600">Checking both calendars for mutual free slots</p>
            </div>

            <!-- Step 3: Time Selection -->
            <div id="timeSelection" class="hidden bg-white rounded-2xl shadow-lg p-8 mb-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Select a Time</h2>
                <p class="text-gray-600 mb-6" id="slotsFound">We found several times that work for both of you</p>

                <div id="timeSlotsList" class="space-y-4">
                    <!-- Time slots will be populated here -->
                </div>

                <button 
                    onclick="confirmBooking()" 
                    id="confirmBtn"
                    class="w-full mt-6 bg-purple-600 text-white font-semibold py-4 px-6 rounded-lg hover:bg-purple-700 transition disabled:opacity-50 disabled:cursor-not-allowed"
                    disabled
                >
                    Book This Time
                </button>
            </div>
        </div>

        <!-- Manual Entry Flow (existing) -->
        <div id="manualFlow" class="hidden">
            <!-- Your existing manual availability entry UI -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Enter Your Availability</h2>
                <p class="text-gray-600 mb-6">Select the days and times you're available</p>
                
                <div class="text-center py-12 text-gray-500">
                    <p>Manual entry UI - reuse your existing code from lines 438-606 of the previous file</p>
                </div>

                <button onclick="selectMethod(null)" class="w-full text-gray-600 hover:text-gray-800 py-2">
                    ← Back to method selection
                </button>
            </div>
        </div>

        <!-- Confirmation -->
        <div id="confirmation" class="hidden bg-white rounded-2xl shadow-lg p-8 text-center">
            <div class="text-6xl mb-4">🎉</div>
            <h2 class="text-3xl font-bold text-gray-800 mb-4">Meeting Booked!</h2>
            <p class="text-gray-600 mb-6">Your meeting has been scheduled and calendar invites have been sent.</p>
            
            <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
                <div class="text-sm text-gray-600 mb-2">Meeting Details:</div>
                <div id="bookingDetails" class="space-y-2">
                    <!-- Details will be populated -->
                </div>
            </div>

            <a 
                href="#" 
                id="meetLink" 
                target="_blank"
                class="inline-block bg-purple-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-purple-700 transition"
            >
                Join Google Meet
            </a>
        </div>
    </div>

    <script>
        const token = window.location.pathname.split('/').pop();
        let selectedMethod = null;
        let selectedTimeSlot = null;
        let availableSlots = [];

        // Initialize
        (async function init() {
            await loadRequestDetails();
            checkGoogleConnectionStatus();
        })();

        async function loadRequestDetails() {
            try {
                const response = await fetch(`/api/availability-requests/${token}`);
                if (!response.ok) throw new Error('Request not found');
                
                const data = await response.json();
                document.getElementById('teamInfo').textContent = 
                    `${data.request.team_name} would like to schedule a meeting with you`;
                
                // Check if already booked
                if (data.request.status === 'booked') {
                    showConfirmation(data.booking);
                }
            } catch (error) {
                showError('Failed to load booking request. The link may be invalid or expired.');
            }
        }

        async function checkGoogleConnectionStatus() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('google_connected') === 'true') {
                showSuccess('Google Calendar connected successfully!');
                document.getElementById('methodSelection').classList.add('hidden');
                document.getElementById('googleFlow').classList.remove('hidden');
                document.getElementById('connectStep').classList.add('hidden');
                document.getElementById('loadingSlots').classList.remove('hidden');
                await loadCalendarSlots();
            }
        }

        function selectMethod(method) {
            selectedMethod = method;
            document.getElementById('methodSelection').classList.add('hidden');
            
            if (method === 'google') {
                document.getElementById('googleFlow').classList.remove('hidden');
                document.getElementById('manualFlow').classList.add('hidden');
            } else if (method === 'manual') {
                document.getElementById('manualFlow').classList.remove('hidden');
                document.getElementById('googleFlow').classList.add('hidden');
            } else {
                // Back to selection
                document.getElementById('methodSelection').classList.remove('hidden');
                document.getElementById('googleFlow').classList.add('hidden');
                document.getElementById('manualFlow').classList.add('hidden');
            }
        }

        async function connectGoogleCalendar() {
            try {
                const response = await fetch(`/api/availability-requests/${token}/connect-google`);
                const data = await response.json();
                
                if (data.authUrl) {
                    window.location.href = data.authUrl;
                } else {
                    showError('Failed to connect Google Calendar');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Failed to connect Google Calendar');
            }
        }

        async function loadCalendarSlots() {
            try {
                const response = await fetch(`/api/availability-requests/${token}/calendar-slots?days=14&duration=60`);
                
                if (!response.ok) {
                    const data = await response.json();
                    if (data.needsGoogleAuth) {
                        document.getElementById('loadingSlots').classList.add('hidden');
                        document.getElementById('connectStep').classList.remove('hidden');
                        return;
                    }
                    throw new Error(data.error || 'Failed to load slots');
                }

                const data = await response.json();
                availableSlots = data.slots;
                
                document.getElementById('loadingSlots').classList.add('hidden');
                
                if (availableSlots.length === 0) {
                    document.getElementById('timeSelection').classList.remove('hidden');
                    document.getElementById('slotsFound').textContent = 
                        'No mutual free times found in the next 14 days. Please contact the organizer directly.';
                    return;
                }

                displayTimeSlots(data.groupedByDate);
                document.getElementById('timeSelection').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error loading slots:', error);
                document.getElementById('loadingSlots').classList.add('hidden');
                showError('Failed to find available time slots. Please try again or use manual entry.');
            }
        }

        function displayTimeSlots(groupedSlots) {
            const container = document.getElementById('timeSlotsList');
            container.innerHTML = '';

            Object.keys(groupedSlots).forEach(date => {
                const dateSection = document.createElement('div');
                dateSection.className = 'mb-4';
                
                const dateHeader = document.createElement('h3');
                dateHeader.className = 'font-semibold text-gray-700 mb-2';
                dateHeader.textContent = date;
                dateSection.appendChild(dateHeader);

                const slotsGrid = document.createElement('div');
                slotsGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

                groupedSlots[date].forEach(slot => {
                    const slotBtn = document.createElement('button');
                    slotBtn.className = 'time-slot border-2 rounded-lg py-3 px-4 text-center hover:border-purple-600';
                    slotBtn.innerHTML = `
                        <div class="font-semibold">${slot.time}</div>
                        <div class="text-xs text-gray-500">${slot.duration} min</div>
                    `;
                    slotBtn.onclick = () => selectTimeSlot(slot, slotBtn);
                    slotsGrid.appendChild(slotBtn);
                });

                dateSection.appendChild(slotsGrid);
                container.appendChild(dateSection);
            });
        }

        function selectTimeSlot(slot, element) {
            // Remove previous selection
            document.querySelectorAll('.time-slot').forEach(el => el.classList.remove('selected'));
            
            // Select new slot
            element.classList.add('selected');
            selectedTimeSlot = slot;
            
            // Enable confirm button
            document.getElementById('confirmBtn').disabled = false;
        }

        async function confirmBooking() {
            if (!selectedTimeSlot) {
                showError('Please select a time slot');
                return;
            }

            const confirmBtn = document.getElementById('confirmBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'Booking...';

            try {
                const response = await fetch(`/api/availability-requests/${token}/book-calendar`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        startTime: selectedTimeSlot.startISO,
                        endTime: selectedTimeSlot.endISO
                    })
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to book meeting');
                }

                const data = await response.json();
                showConfirmation(data.booking);
                
            } catch (error) {
                console.error('Error booking:', error);
                showError(error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'Book This Time';
            }
        }

        function showConfirmation(booking) {
            document.getElementById('methodSelection').classList.add('hidden');
            document.getElementById('googleFlow').classList.add('hidden');
            document.getElementById('manualFlow').classList.add('hidden');
            document.getElementById('confirmation').classList.remove('hidden');

            document.getElementById('bookingDetails').innerHTML = `
                <div class="font-semibold text-lg">${booking.date}</div>
                <div class="text-gray-600">${booking.time}</div>
                ${booking.meetLink ? `<div class="text-sm text-purple-600 mt-2">Google Meet link included</div>` : ''}
            `;

            if (booking.meetLink) {
                const meetLink = document.getElementById('meetLink');
                meetLink.href = booking.meetLink;
                meetLink.classList.remove('hidden');
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '✗ ' + message;
            errorDiv.classList.remove('hidden');
            setTimeout(() => errorDiv.classList.add('hidden'), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = '✓ ' + message;
            successDiv.classList.remove('hidden');
            setTimeout(() => successDiv.classList.add('hidden'), 5000);
        }
    </script>
</body>
</html>